# MAES Domain Setup Guide

This guide explains how to configure MAES for both localhost development and production deployment with custom domains and Let's Encrypt SSL certificates.

## Overview

MAES supports two deployment modes:
- **Localhost Mode**: Perfect for development with self-signed certificates
- **Production Mode**: Custom domains with automatic Let's Encrypt SSL certificates

## Quick Start

### 🏠 Localhost Development (Default)

No configuration needed! Just run:

```bash
docker-compose up -d
```

Access at: **https://localhost** (accept the self-signed certificate warning)

### 🌍 Production with Custom Domain

Use the automated setup script:

```bash
./scripts/setup-domain.sh maes.yourdomain.com admin@yourdomain.com
```

## Detailed Configuration

### Environment Variables

Create a `.env` file or copy from `.env.example`:

```bash
# Domain Configuration
DOMAIN=localhost                    # Your domain (localhost for dev)
USE_LETS_ENCRYPT=false             # Enable Let's Encrypt (true for production)
EMAIL=admin@yourdomain.com         # Required for Let's Encrypt
LETSENCRYPT_STAGING=false          # Use staging environment for testing

# Application URLs
API_URL=https://localhost:3000     # API endpoint URL

# Database & Security (auto-generated by setup script)
POSTGRES_PASSWORD=secure_password
REDIS_PASSWORD=secure_password
JWT_SECRET=your_secret
SERVICE_AUTH_TOKEN=service_token
ENCRYPTION_KEY=32_character_key
```

### Manual Setup

#### 1. Localhost Development

```bash
# 1. Set environment
echo "DOMAIN=localhost" > .env
echo "USE_LETS_ENCRYPT=false" >> .env

# 2. Start services
docker-compose up -d

# 3. Access application
open https://localhost
```

#### 2. Production with Let's Encrypt

```bash
# 1. Configure environment
cat > .env << EOF
DOMAIN=maes.yourdomain.com
USE_LETS_ENCRYPT=true
EMAIL=admin@yourdomain.com
LETSENCRYPT_STAGING=false
EOF

# 2. Initialize Let's Encrypt
chmod +x ssl/init-letsencrypt.sh
./ssl/init-letsencrypt.sh

# 3. Start production services
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

#### 3. Custom Domain with Self-Signed Certificate

```bash
# 1. Configure environment
cat > .env << EOF
DOMAIN=maes.yourdomain.com
USE_LETS_ENCRYPT=false
EMAIL=admin@yourdomain.com
EOF

# 2. Start services
docker-compose up -d
```

## DNS Configuration

For custom domains, ensure your DNS is configured correctly:

### A Record Configuration

Point your domain to your server's IP address:

```
Type: A
Name: maes (or your subdomain)
Value: YOUR.SERVER.IP.ADDRESS
TTL: 300 (5 minutes)
```

### Verification

Test DNS resolution:

```bash
# Check if domain resolves
nslookup maes.yourdomain.com

# Test HTTP connectivity
curl -I http://maes.yourdomain.com
```

## SSL Certificate Management

### Let's Encrypt Features

- **Automatic Certificate Generation**: Certificates are created during first startup
- **Auto-Renewal**: Certificates renew every 12 hours automatically
- **Staging Support**: Test with staging environment before production
- **OCSP Stapling**: Enhanced security and performance

### Certificate Locations

```
/etc/letsencrypt/live/YOUR_DOMAIN/
├── fullchain.pem    # SSL certificate + intermediate chain
├── privkey.pem      # Private key
├── cert.pem         # SSL certificate only
└── chain.pem        # Intermediate certificate chain
```

### Manual Certificate Operations

```bash
# Check certificate status
docker-compose exec certbot certbot certificates

# Manually renew certificates
docker-compose exec certbot certbot renew

# Test renewal (dry run)
docker-compose exec certbot certbot renew --dry-run

# Force certificate regeneration
docker-compose run --rm certbot certbot delete --cert-name YOUR_DOMAIN
./ssl/init-letsencrypt.sh
```

## Troubleshooting

### Common Issues

#### 1. Domain Not Accessible

**Symptoms**: Let's Encrypt fails, "Domain not accessible" error

**Solutions**:
- Verify DNS points to your server
- Check firewall allows ports 80 and 443
- Ensure no other web server is running
- Test with `curl -I http://yourdomain.com`

#### 2. Certificate Renewal Fails

**Symptoms**: Certificate expires, renewal errors in logs

**Solutions**:
```bash
# Check certbot logs
docker-compose logs certbot

# Check nginx configuration
docker-compose exec frontend nginx -t

# Manually renew and reload
docker-compose exec certbot certbot renew
docker-compose exec frontend nginx -s reload
```

#### 3. CORS Errors

**Symptoms**: Frontend can't connect to API, CORS policy errors

**Solutions**:
- Verify `DOMAIN` matches your actual domain
- Check `API_URL` points to correct endpoint
- Restart API service: `docker-compose restart api`

#### 4. SSL Certificate Errors

**Symptoms**: Browser shows SSL warnings, certificate mismatch

**Solutions**:
```bash
# Check certificate details
openssl x509 -in /path/to/cert.pem -text -noout

# Regenerate certificates
./ssl/init-letsencrypt.sh

# For development, use localhost:
echo "DOMAIN=localhost" > .env
docker-compose restart frontend
```

### Debug Commands

```bash
# View all service logs
docker-compose logs -f

# Check specific service
docker-compose logs -f frontend
docker-compose logs -f certbot
docker-compose logs -f api

# Check nginx configuration
docker-compose exec frontend nginx -t

# Check SSL certificate
docker-compose exec frontend openssl x509 -in /etc/nginx/ssl/cert.pem -text -noout

# Test domain connectivity
curl -I http://yourdomain.com
curl -I https://yourdomain.com
```

## Security Considerations

### Production Checklist

- [ ] Use strong, unique passwords in `.env`
- [ ] Enable firewall (allow only 80, 443, and SSH)
- [ ] Regular security updates
- [ ] Monitor certificate expiration
- [ ] Use staging environment for testing
- [ ] Backup Let's Encrypt certificates
- [ ] Monitor logs for suspicious activity

### Firewall Configuration

```bash
# UFW (Ubuntu/Debian)
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# iptables
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

## Advanced Configuration

### Custom SSL Certificates

To use your own SSL certificates instead of Let's Encrypt:

1. Place certificates in `certs/` directory:
   ```
   certs/
   ├── custom.crt
   └── custom.key
   ```

2. Modify `docker-compose.yml` to mount certificates:
   ```yaml
   frontend:
     volumes:
       - ./certs:/etc/nginx/ssl:ro
   ```

3. Set environment variables:
   ```bash
   USE_LETS_ENCRYPT=false
   SSL_CERT_PATH=/etc/nginx/ssl/custom.crt
   SSL_KEY_PATH=/etc/nginx/ssl/custom.key
   ```

### Multiple Domains

To support multiple domains, modify `nginx.conf.template`:

```nginx
server {
    listen 443 ssl http2;
    server_name domain1.com domain2.com *.domain1.com;
    # ... rest of configuration
}
```

### Load Balancer Integration

When using a load balancer (AWS ALB, Cloudflare, etc.):

1. Configure load balancer to handle SSL termination
2. Set `USE_LETS_ENCRYPT=false`
3. Configure nginx for HTTP only:
   ```bash
   FORCE_HTTPS_REDIRECT=false
   ```

## Migration Guide

### From Localhost to Production

1. Export existing data (if needed)
2. Configure production environment
3. Run setup script with your domain
4. Migrate data and configurations
5. Update DNS to point to production server

### From Self-Signed to Let's Encrypt

1. Update `.env`: `USE_LETS_ENCRYPT=true`
2. Run: `./ssl/init-letsencrypt.sh`
3. Restart services: `docker-compose restart`

## Support

For additional help:
- Check logs: `docker-compose logs -f`
- Review [troubleshooting guide](../TROUBLESHOOTING.md)
- Submit issues on GitHub